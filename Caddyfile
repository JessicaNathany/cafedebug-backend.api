# Caddy Configuration for CafeDebug API
# Modern reverse proxy with automatic HTTPS and better Docker Swarm support

# Production configuration with HTTPS
{$DOMAIN:localhost} {
    # Reverse proxy to API service
    reverse_proxy cafedebug-api:80 {
        # Health check configuration
        health_uri /health
        health_interval 10s
        health_timeout 5s
        health_status 200

        # Connection pooling for better performance
        policy least_request

        # Timeout configurations
        timeout 30s

        # Error handling and retries
        transport http {
            dial_timeout 10s
            response_header_timeout 30s
            keep_alive 90s
            max_idle_conns 100
        }
    }

    # Security headers
    header X-Content-Type-Options nosniff
    header X-Frame-Options DENY
    header X-XSS-Protection "1; mode=block"
    header Referrer-Policy "strict-origin-when-cross-origin"
    header Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # Compression for better performance
    encode gzip

    # Logging configuration
    log {
        output stdout
        format json {
            time_format iso8601
        }
    }

    # Rate limiting (optional - uncomment to enable)
    # rate_limit {
    #     zone dynamic {
    #         key {remote_ip}
    #         events 100
    #         window 1m
    #     }
    # }
}

# Development configuration (uncomment for local development)
# localhost {
#     reverse_proxy cafedebug-api:80 {
#         health_uri /health
#         health_interval 10s
#     }
#     
#     log {
#         output stdout
#         format console
#     }
# }
