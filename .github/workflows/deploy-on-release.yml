name: Deploy on Release

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: read # REQUIRED to pull images from GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}

      - name: Resolve image tag
        id: image
        run: |
          # Calculate the Short SHA to match your Build Workflow
          COMMIT="${{ github.event.release.target_commitish }}"
          COMMIT_SHORT=$(echo $COMMIT | cut -c1-7)
          # Ensure this format matches what your CI pushes!
          IMAGE_TAG="main-${COMMIT_SHORT}"
          
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image tag: ${IMAGE_TAG}"

      - name: Generate .env file
        run: |
          # Create .env on the runner temporarily
          cat > .env << EOF
          # Generated by GitHub Actions
          IMAGE_TAG=${{ steps.image.outputs.tag }}
          ASPNETCORE_ENVIRONMENT=Production
          
          # Caddy Configuration
          CADDY_DOMAIN=${{ vars.CADDY_DOMAIN }}
          
          # Database Configuration
          DB_CONNECTION_STRING=${{ vars.DB_CONNECTION }}
          
          # JWT Configuration
          JWT_ISSUER=${{ vars.JWT_ISSUER }}
          JWT_AUDIENCE=${{ vars.JWT_AUDIENCE }}
          JWT_SIGNING_KEY=${{ vars.JWT_SIGNING_KEY }}
          JWT_VALID_MINUTES=15
          JWT_REFRESH_TOKEN_VALID_MINUTES=10080
          
          # AWS S3 Storage
          AWS_S3_BUCKET=${{ vars.AWS_S3_BUCKET }}
          AWS_S3_REGION=${{ vars.AWS_S3_REGION }}
          AWS_ACCESS_KEY_ID=${{ vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ vars.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BASE_URL=${{ vars.AWS_S3_BASE_URL }}
          
          # Email/SMTP Configuration
          SMTP_SERVER=${{ vars.SMTP_SERVER }}
          SMTP_PORT=${{ vars.SMTP_PORT }}
          SMTP_USERNAME=${{ vars.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ vars.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL=${{ vars.SMTP_FROM_EMAIL }}
          EOF
          chmod 600 .env
          
          # Validate .env was created
          if [ ! -f .env ]; then
            echo "ERROR: .env file was not created"
            exit 1
          fi
          echo "✓ .env file created successfully"

      - name: Prepare Remote Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.AWS_EC2_HOST }}
          username: ${{ vars.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ vars.AWS_EC2_PORT }}
          script: |
            mkdir -p ${{ vars.DOCKER_COMPOSE_PATH }}/scripts

      - name: Copy Config & Scripts to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ vars.AWS_EC2_HOST }}
          username: ${{ vars.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ vars.AWS_EC2_PORT }}
          source: ".env,docker-compose.yml,Caddyfile,scripts/"
          target: "${{ vars.DOCKER_COMPOSE_PATH }}"
          strip_components: 0

      - name: Execute Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.AWS_EC2_HOST }}
          username: ${{ vars.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ vars.AWS_EC2_PORT }}
          script: |
            set -e
            cd ${{ vars.DOCKER_COMPOSE_PATH }}
            
            # Fix permissions for the newly copied files
            chmod 600 .env
            chmod +x scripts/deploy.sh
            
            # Login to Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Run the deploy script
            # We pass the tag, but the script also loads it from .env (redundancy is fine)
            bash scripts/deploy.sh "${{ steps.image.outputs.tag }}"

      - name: Verify Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.AWS_EC2_HOST }}
          username: ${{ vars.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ vars.AWS_EC2_PORT }}
          script: |
            set -e
            cd ${{ vars.DOCKER_COMPOSE_PATH }}
            
            echo "Verifying deployment..."
            
            # Check service status
            docker service ls | grep cafedebug-stack
            
            # Check running replicas
            REPLICAS=$(docker service ls --filter name=cafedebug-stack_cafedebug-api --format "{{.Replicas}}")
            echo "API Replicas: $REPLICAS"
            
            # Show recent logs (last 20 lines)
            echo "Recent logs:"
            docker service logs --tail 20 cafedebug-stack_cafedebug-api || true
            
            echo "✓ Deployment verification complete"