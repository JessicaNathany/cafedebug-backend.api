name: Deploy on Release

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: read # REQUIRED to pull images from GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}

      - name: Resolve image tag
        id: image
        run: |
          # Use the actual commit SHA from the checkout
          COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${COMMIT_SHORT}"
          
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image tag: ${IMAGE_TAG}"

      - name: Generate .env file
        run: |
          set +u  # Disable unbound variable check to handle $ in passwords
          # Create .env on the runner temporarily
          cat > .env << EOF
          # Generated by GitHub Actions
          IMAGE_TAG=${{ steps.image.outputs.tag }}
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          ASPNETCORE_ENVIRONMENT=Production
          
          # Caddy Configuration
          CADDY_DOMAIN=${{ vars.CADDY_DOMAIN }}
          
          # Database Configuration
          ConnectionStrings__CafedebugConnectionStringMySQL=${{ vars.DB_CONNECTION }}
          
          # JWT Configuration
          JwtSettings__Issuer=${{ vars.JWT_ISSUER }}
          JwtSettings__Audience=${{ vars.JWT_AUDIENCE }}
          JwtSettings__SigningKey=${{ vars.JWT_SIGNING_KEY }}
          JwtSettings__ValidForMinutes=15
          JwtSettings__RefreshTokenValidForMinutes=10080
          
          # AWS S3 Storage
          Storage__AWS__S3__Bucket=${{ vars.AWS_S3_BUCKET }}
          Storage__AWS__S3__Region=${{ vars.AWS_S3_REGION }}
          Storage__AWS__S3__BaseUrl=${{ vars.AWS_S3_BASE_URL }}
          Storage__AWS__S3__ServiceUrl=null
          Storage__AWS__S3__ForcePathStyle=false
          Storage__AWS__S3__UseHttp=false
          
          # Email/SMTP Configuration
          SMTP_SERVER=${{ vars.SMTP_SERVER }}
          SMTP_PORT=${{ vars.SMTP_PORT }}
          SMTP_USERNAME=${{ vars.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ vars.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL=${{ vars.SMTP_FROM_EMAIL }}
          SMTP_FROM_NAME=${{ vars.SMTP_FROM_NAME }}

          EOF
          
          # Validate .env was created
          if [ ! -f .env ]; then
            echo "ERROR: .env file was not created"
            exit 1
          fi
          echo "✓ .env file created successfully"

      - name: Transfer all files to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ vars.AWS_EC2_HOST }}
          username: ${{ vars.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ vars.AWS_EC2_PORT }}
          source: ".env,docker-compose.yml,Caddyfile,scripts/deploy.sh"
          target: "${{ vars.DOCKER_COMPOSE_PATH }}/"
          strip_components: 0 # Do not strip any path components
          overwrite: true
          timeout: 120s

      - name: Execute Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.AWS_EC2_HOST }}
          username: ${{ vars.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: ${{ vars.AWS_EC2_PORT }}
          script: |
            set -e
            cd "${{ vars.DOCKER_COMPOSE_PATH }}"
            
            # 1. Verify files were copied  
            ls -lah .env docker-compose.yml Caddyfile scripts/deploy.sh

            # 2. Set Permissions            
            chmod 600 .env
            chmod +x scripts/deploy.sh
            
            # 3. Login to Registry        
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            
            # 4. Run the deploy script            
            bash scripts/deploy.sh "${{ steps.image.outputs.tag }}"

            # 5. Logout from registry 
            docker logout ghcr.io

            # 6. Verify Deployment
            echo "Verifying deployment..."

            # 6.1 Check service status
            docker service ls | grep cafedebug-stack
            
            # 6.2 Check running replicas
            REPLICAS=$(docker service ls --filter name=cafedebug-stack_cafedebug-api --format "{{.Replicas}}")
            echo "API Replicas: $REPLICAS"
            
            # 6.3 Show recent logs (last 20 lines)
            echo "Recent logs:"
            docker service logs --tail 20 cafedebug-stack_cafedebug-api || true
            
            echo "✓ Deployment verification complete"          